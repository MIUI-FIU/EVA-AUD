(self.webpackChunkEVA_AUD=self.webpackChunkEVA_AUD||[]).push([[743],{39161:(e,t,o)=>{"use strict";o.d(t,{A:()=>a});var n=o(38685);const a=class{constructor(e,t,o){this.animationManager=e,this.apiKey=t,this.region=o,this.queue=[],this.isSpeaking=!1,this.audioInterrupt=!1,this.speechConfig=n.SpeechConfig.fromSubscription(this.apiKey,this.region),this.initSynthesizer()}recognizeSpeechUntilSilence(){return new Promise(((e,t)=>{const o=n.AudioConfig.fromDefaultMicrophoneInput(),a=new n.SpeechRecognizer(this.speechConfig,o);let s="",i=null;let r=null;i=setTimeout((()=>{console.log("Silence detected (before recognition), stopping recognition..."),a.stopContinuousRecognitionAsync((()=>{e({text:s.trim(),timestamp:r})}))}),3e3),a.recognizing=(t,o)=>{console.log("Recognizing event triggered"),console.log("Partial result: ".concat(o.result.text)),clearTimeout(i),i=setTimeout((()=>{console.log("Silence detected during recognition, stopping..."),a.stopContinuousRecognitionAsync((()=>{e({text:s.trim(),timestamp:r})}))}),3e3)},a.recognized=(e,t)=>{console.log("Recognized event triggered"),t.result.reason===n.ResultReason.RecognizedSpeech?(console.log("Final result: ".concat(t.result.text)),s+=t.result.text+" ",r=Date.now()):t.result.reason===n.ResultReason.NoMatch&&console.log("No match found.")},a.canceled=(e,o)=>{console.error("Canceled event triggered"),console.error("Recognition canceled: ".concat(o.reason)),a.stopContinuousRecognitionAsync((()=>{t(new Error("Recognition canceled: ".concat(o.reason)))}))},a.sessionStopped=(t,o)=>{console.log("Session stopped due to silence"),a.stopContinuousRecognitionAsync((()=>{e({text:s.trim(),timestamp:r})}))},console.log("Starting continuous recognition..."),a.startContinuousRecognitionAsync((()=>console.log("Recognition started successfully")),(e=>{console.error("Error starting recognition:",e),t(e)}))}))}initSynthesizer(){this.speechConfig.speechSynthesisVoiceName="en-US-JennyNeural";const e=new n.SpeakerAudioDestination,t=n.AudioConfig.fromSpeakerOutput(e);this.synthesizer=new n.SpeechSynthesizer(this.speechConfig,t),this.synthesizer.visemeReceived=(e,t)=>{this.scheduleVisemeApplication(t.visemeId,t.audioOffset)}}enqueueText(e){this.queue.push(e),this.isSpeaking||this.processQueue()}processQueue(){if(0===this.queue.length)return void(this.isSpeaking=!1);this.isSpeaking=!0;const e=this.queue.shift();this.synthesizeSpeech(e).then((()=>this.processQueue()))}synthesizeSpeech(e){return new Promise(((t,o)=>{this.synthesizer.speakTextAsync(e,(e=>{console.log("Speech synthesis completed."),t(e)}),(e=>{console.log("Error during speech synthesis, restarting"),o(e)}))}))}scheduleVisemeApplication(e,t){setTimeout((()=>{this.applyVisemeToCharacter(e)}),t/1e4)}applyVisemeToCharacter(e){const t=this.animationManager.facsLib;this.audioInterrupt?(this.animationManager.setFaceToNeutral(),t.setNeutralViseme()):0===e?t.setNeutralViseme(0):(e-=1,t.setTargetViseme(e,70,0)),t.updateEngine()}stopSpeech(){this.synthesizer.close(),this.queue=[],this.isSpeaking=!1,this.initSynthesizer(),console.log("Speech synthesis stopped.")}interruptSpeech(e){this.synthesizer.close(),this.queue=[],this.isSpeaking=!1,this.initSynthesizer(),e&&this.enqueueText(e),console.log("Speech synthesis interrupted.")}}},80019:(e,t,o)=>{"use strict";o.d(t,{A:()=>i});var n=o(65043),a=o(13531),s=o(70579);const i=e=>{let{onEmotionDetected:t,stopVideoRef:o}=e;const i=(0,n.useRef)(),r=(0,n.useRef)(),l=(0,n.useRef)(),c=(0,n.useRef)();(0,n.useEffect)((()=>{(async()=>{try{const e="/EVA-libre/models";await a.B0.tinyFaceDetector.loadFromUri(e),await a.B0.faceLandmark68Net.loadFromUri(e),await a.B0.faceRecognitionNet.loadFromUri(e),await a.B0.faceExpressionNet.loadFromUri(e),u()}catch(e){console.error("Error loading models:",e)}})()}),[]);const u=()=>{navigator.mediaDevices.getUserMedia({video:{}}).then((e=>{c.current=e,i.current.srcObject=e})).catch((e=>console.error("Error accessing webcam:",e)))},h=()=>{c.current&&c.current.getTracks().forEach((e=>e.stop()))},d=async()=>{if(!i.current||i.current.paused||i.current.ended)return;const e=await a.R(i.current,new a.ex).withFaceLandmarks().withFaceExpressions(),o=r.current;if(!o)return void console.error("Canvas is not available");const n={width:i.current.videoWidth,height:i.current.videoHeight};a.L0(o,n);const s=a.Lz(e,n);if(o.getContext("2d").clearRect(0,0,o.width,o.height),a.$2.drawDetections(o,s),a.$2.drawFaceLandmarks(o,s),a.$2.drawFaceExpressions(o,s),e.length>0){const o=e[0].expressions,n=Object.entries(o).map((e=>{let[t,o]=e;return[t,o,Date.now()]})).sort(((e,t)=>t[1]-e[1]));t&&t(n)}};return(0,n.useEffect)((()=>{const e=()=>{l.current||(l.current=setInterval(d,100))},t=i.current;return null===t||void 0===t||t.addEventListener("play",e),o&&(o.current=h),()=>{clearInterval(l.current),l.current=null,null===t||void 0===t||t.removeEventListener("play",e)}}),[]),(0,s.jsxs)("div",{style:{position:"relative"},children:[(0,s.jsx)("video",{ref:i,autoPlay:!0,muted:!0,width:"480",height:"270",style:{position:"relative"}}),(0,s.jsx)("canvas",{ref:r,style:{position:"absolute",left:0,top:0}})]})}},62395:(e,t,o)=>{"use strict";o.r(t),o.d(t,{start:()=>le,stop:()=>ce});var n=o(43317),a=o(84391),s=o(65043),i=o(80019),r=o(88188),l=o(39161),c=o(93748),u=o(70579);let h=null;const d=["surprised","disgusted","fearful","sad","angry","happy","neutral"];let g,m,y,p,f=null,w=null,v=!0,_=[];const k=4e3;let b="mistral",N=3,E=3,x=3;const q=["Understood","Got it","Okay","Alright","Right"];let T,L,I,S,R=!1,Q=!1,D=!1,C="Default text";const A=e=>{m=e[0],g=m[2],1==v&&_.push(m)};function M(e){return new Promise((t=>setTimeout(t,e)))}async function O(e,t){let o=arguments.length>2&&void 0!==arguments[2]&&arguments[2];L.initSynthesizer();let n=await L.synthesizeSpeech(e);const a=n.audioDuration/1e4;C=e,he(),o&&t({title:"eEVA Response",description:e,status:"info",duration:0,isClosable:!1}),console.log("synthesize_result object:",n),console.log("synthesize result transcript:",e),console.log("synthesize result audioDuration:",n.audioDuration),console.log("before delay!");try{await M(a),console.log("after delay!")}catch(s){"Delay aborted"===s.message?console.log("Delay was aborted"):console.error("Error during delay:",s)}}function U(){const e={name:"AUDIT questionnaire",max_score:40,introduction:"Let's start the AUDIT questionnaire. This questionnaire is used to determine if this program is worth your time and effort. Let's begin.",questions:["How often do you have a drink containing alcohol?","How many drinks containing alcohol do you have on a typical day when you are drinking?","How often do you have four or more drinks on one occasion?","How often during the last year have you found that you were not able to stop drinking once you had started?","How often during the last year have you failed to do what was normally expected from you because of drinking?","How often during the last year have you needed a first drink in the morning to get yourself going after a heavy drinking session?","How often during the last year have you had a feeling of guilt or remorse after drinking?","How often during the last year have you been unable to remember what happened the night before because you had been drinking?","Have you or someone else been injured as a result of your drinking?","Has a relative or friend, or a doctor or other health worker been concerned about your drinking or suggested you cut down?"],response_categories:[["Never","Once a month","Two to four times a month","Two to three times a week","more than three times a week"],["zero","one or two","three or four","five or six","seven to nine","ten or more"],["Never","Less than monthly","Monthly","Weekly","Daily","almost daily"],["Never","Less than monthly","Monthly","Weekly","Daily","almost daily"],["Never","Less than monthly","Monthly","Weekly","Daily","almost daily"],["Never","Less than monthly","Monthly","Weekly","Daily","almost daily"],["Never","Less than monthly","Monthly","Weekly","Daily","almost daily"],["Never","Less than monthly","Monthly","Weekly","Daily","almost daily"],["No","Yes, but not in the last year","Yes, during the last year"],["No","Yes, but not in the last year","Yes, during the last year"]],response_categories_match:[["Never","Once a month","two times a month","three times a month","four times a month","two times a week","three times a week","more than three times a week"],["zero","one","two","three","four","five","six","seven","eight","nine","more than ten"],["Never","Less than monthly","Monthly","Weekly","Daily","almost daily"],["Never","Less than monthly","Monthly","Weekly","Daily","almost daily"],["Never","Less than monthly","Monthly","Weekly","Daily","almost daily"],["Never","Less than monthly","Monthly","Weekly","Daily","almost daily"],["Never","Less than monthly","Monthly","Weekly","Daily","almost daily"],["Never","Less than monthly","Monthly","Weekly","Daily","almost daily"],["No","Yes, but not in the last year","Yes, during the last year"],["No","Yes, but not in the last year","Yes, during the last year"]],scoring_categories:[[0,1,2,2,2,3,3,4],[0,0,0,1,1,2,2,3,3,3,4],[0,1,2,3,4,4],[0,1,2,3,4,4],[0,1,2,3,4,4],[0,1,2,3,4,4],[0,1,2,3,4,4],[0,1,2,3,4,4],[0,2,4],[0,2,4]]},t={agent_greeting:"Hello, my name is eva.",introduction:"Let's go through some questionnaires to help review your drinking.",questionnaires:[e]},o={agent_greeting:"Hello, my name is eva.",introduction:"Let's go through some questionnaires to help review your drinking.",questionnaires:[{name:"AUDIT questionnaire",max_score:40,introduction:"Let's start the AUDIT questionnaire. This questionnaire is used to determine if this program is worth your time and effort. Let's begin.",questions:["How often do you have a drink containing alcohol?","How many drinks containing alcohol do you have on a typical day when you are drinking?","How often do you have four or more drinks on one occasion?","How often during the last year have you found that you were not able to stop drinking once you had started?","How often during the last year have you failed to do what was normally expected from you because of drinking?","How often during the last year have you needed a first drink in the morning to get yourself going after a heavy drinking session?","How often during the last year have you had a feeling of guilt or remorse after drinking?","How often during the last year have you been unable to remember what happened the night before because you had been drinking?","Have you or someone else been injured as a result of your drinking?","Has a relative or friend, or a doctor or other health worker been concerned about your drinking or suggested you cut down?"],target_questions:["How often do you have a drink containing alcohol?","How many drinks containing alcohol do you have on a typical day when you are drinking?","How often do you have four or more drinks on one occasion?","How often during the last year have you found that you were not able to stop drinking once you had started?","How often during the last year have you failed to do what was normally expected from you because of drinking?","How often during the last year have you needed a first drink in the morning to get yourself going after a heavy drinking session?","How often during the last year have you had a feeling of guilt or remorse after drinking?","How often during the last year have you been unable to remember what happened the night before because you had been drinking?","Have you or someone else been injured as a result of your drinking?","Has a relative or friend, or a doctor or other health worker been concerned about your drinking or suggested you cut down?"],response_categories:[["Never","Once a month","Two to four times a month","Two to three times a week","more than three times a week"],["zero","one or two","three or four","five or six","seven to nine","ten or more"],["Never","Less than monthly","Monthly","Weekly","Daily","almost daily"],["Never","Less than monthly","Monthly","Weekly","Daily","almost daily"],["Never","Less than monthly","Monthly","Weekly","Daily","almost daily"],["Never","Less than monthly","Monthly","Weekly","Daily","almost daily"],["Never","Less than monthly","Monthly","Weekly","Daily","almost daily"],["Never","Less than monthly","Monthly","Weekly","Daily","almost daily"],["No","Yes, but not in the last year","Yes, during the last year"],["No","Yes, but not in the last year","Yes, during the last year"]],response_categories_match:[["Never","Once a month","two times a month","three times a month","four times a month","two times a week","three times a week","more than three times a week"],["zero","one","two","three","four","five","six","seven","eight","nine","more than ten"],["Never","Less than monthly","Monthly","Weekly","Daily","almost daily"],["Never","Less than monthly","Monthly","Weekly","Daily","almost daily"],["Never","Less than monthly","Monthly","Weekly","Daily","almost daily"],["Never","Less than monthly","Monthly","Weekly","Daily","almost daily"],["Never","Less than monthly","Monthly","Weekly","Daily","almost daily"],["Never","Less than monthly","Monthly","Weekly","Daily","almost daily"],["No","Yes, but not in the last year","Yes, during the last year"],["No","Yes, but not in the last year","Yes, during the last year"]],scoring_categories:[[0,1,2,2,2,3,3,4],[0,0,0,1,1,2,2,3,3,3,4],[0,1,2,3,4,4],[0,1,2,3,4,4],[0,1,2,3,4,4],[0,1,2,3,4,4],[0,1,2,3,4,4],[0,1,2,3,4,4],[0,2,4],[0,2,4]]}]};console.log("activeListeningTrigger:",S),I=1==S?o:t,console.log("intervention_dict:",I)}async function z(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];try{t&&e({title:"eEVA Response",description:"Started Listening...",status:"success",duration:0,isClosable:!1});const o=await L.recognizeSpeechUntilSilence();return C="",he(),t&&e({title:"eEVA Response",description:"Stopped Listening...",status:"error",duration:0,isClosable:!1}),o}catch(o){throw console.log("Error during speech recognition:",o),t&&e({title:"Error",description:"Speech recognition failed.",status:"error",duration:0,isClosable:!0}),o}}function V(e){let t=e;return t=t.replace(/[^\w\s]|_/g,"").replace(/\s+/g," "),t=t.toLowerCase(),t}async function H(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],o=(await r.A.chat({model:b,messages:[{role:"user",content:e}]})).message.content;return 1==t&&(o=V(o)),o}async function P(e,t){let o="Please check if the following user response: '".concat(e,"' answers or indirectly implies an answer to the question: '").concat(t,'. Respond with "yes" if the response implies a relevant answer, even if it\'s not stated in the exact terms of the question. Respond with "no" only if it does not imply any relevant answer.');console.log("llm relevancy prompt: ".concat(o));let n=await H(o,!0);return n=n.toLowerCase().trim(),console.log("llm relevancy response: ".concat(n)),n.includes("yes")}async function W(e,t){return await async function(e,t){let o=[];for(let s=0;s<N;s++)o.push(await P(e,t));let n=0;for(let s=0;s<o.length;s++)1==o[s]&&(n+=1);let a=!1;return n>parseInt(Math.floor(o.length/2))&&(a=!0),a}(e,t)}function Y(e){let t="";console.log("chosen array type: ".concat(typeof e));for(let o=0;o<e.length;o++){let n=e[o];o==e.length-1?t+="or ".concat(n,"."):t+="".concat(n,", ")}return t}function F(e){let t="";return e.forEach((e=>{t+="\n*".concat(e)})),t}function G(e){let t={},o=0,n=null;for(let a of e)null!=a&&(t[a]=(t[a]||0)+1,t[a]>o&&(o=t[a],n=a));return n}async function j(e,t){let o=F(t);o=o.toLowerCase().trim();let n="Please match the following user response: '".concat(e,"' to the following valid responses: \n").concat(o,"\nAlways match to the exact closest valid response. Be direct and succinct.");console.log("llm match prompt: ".concat(n));let a=(await r.A.chat({model:b,messages:[{role:"user",content:n}]})).message.content;a=a.toLowerCase().trim(),console.log("llm match response: ".concat(a));let s=null;for(let i=0;i<t.length;i++){let e=t[i].toLowerCase().trim();if(a===e){console.log("EXACT MATCH!"),console.log("llm_response_msg_content:",a),console.log("element:",e),s=i;break}if(a.includes(e)){console.log("SUBSTRING MATCH!"),console.log("llm_response_msg_content:",a),console.log("element:",e),s=i;break}}return console.log("match_index:",s),s}async function B(e,t){let o=[];for(let n=0;n<E;n++)o.push(await j(e,t));return console.log("match_index_list:",o),G(o)}async function J(e,t){let o=null,n=0;for(;null==o&&n<2;)o=await B(e,t),n+=1;return o}async function K(e,t,o){let n="Given the following relevant user response, '".concat(e,"' to '").concat(t,"', please provide a reflective listening response that acknowledges their response to the closest response match equivalent of ").concat(o," and guides them to confirm your understanding of the user response.");console.log("llm reflective listening response:",n);let a=await H(n);return a=a.toLowerCase().trim(),console.log("llm followup response: ".concat(a)),a}async function X(e,t){let o="Given the following user response, '".concat(e,"' to following agent response:'").concat(t,"', check if the user is directly or indirectly responding with a form of 'yes'. Respond with 'yes' if they are and 'no' if they do not. Be direct and succinct by giving a 1 word response.");console.log("llm confirm prompt: ".concat(o));let n=await H(o,!0);return n=n.toLowerCase().trim(),console.log("llm cofirm response: ".concat(n)),n.includes("yes")}async function $(e,t,o){let n="Given the following user response, '".concat(e,"' to '").concat(t,"', please provide a follow-up question that acknowledges their response and guides them to answer '").concat(o,"'.");console.log("llm followup prompt: ".concat(n));let a=await H(n);return a=a.toLowerCase().trim(),console.log("llm followup response: ".concat(a)),a}async function Z(e){let t=F(d);t=t.toLowerCase().trim();let o="Please match from the following text: '".concat(e,"' to one of the following emotions:\n").concat(t,"\n");console.log("llm emotion prompt: ".concat(o));let n=await H(o,!0);n=n.toLowerCase().trim(),console.log("llm emotion response: ".concat(n));let a=null;for(let s=0;s<d.length;s++){let e=d[s].toLowerCase().trim();if(n.includes(e)){console.log("MATCH!"),console.log("llm_response_msg_content:",n),console.log("element:",e),a=s;break}}return console.log("match_index:",a),a}async function ee(e){let t=[];for(let o=0;o<x;o++)t.push(await Z(e));return console.log("match_index_list:",t),G(t)}async function te(e){let t=null,o=0;for(;null==t&&o<2;)t=await ee(e),o+=1;return t}function oe(){var e;h={id:crypto.randomUUID(),datetime:(e=Date.now(),new Date(e).toLocaleString("en-US",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"})),user_data:{},transcript:{introduction:"",questionnaires:[]}},console.log("init conversation_log:",JSON.stringify(h,null,2))}function ne(e){let t=null,o=1/0;for(let n=0;n<_.length;n++){const a=_[n],s=a[2],i=Math.abs(s-e);i<o&&(o=i,t=a)}return t}async function ae(e){console.log("IN START PROCEDURE!"),console.log("activeListeningTrigger:",S),D=!1,await M(3e3),1==S?(console.log("RUNNING ACTIVE LISTENING AGENT DRIVEN INTERVENTION!!!"),e({title:"eEVA Procedure",description:"RUNNING ACTIVE LISTENING AGENT DRIVEN INTERVENTION!!!",status:"success",duration:0,isClosable:!1}),async function(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];U(),oe(),ue();let o=I.agent_greeting;await O(o,e,!1),await O(I.introduction,e,!1),h.transcript.introduction="".concat(o," ").concat(I.introduction);let n=I.questionnaires,a={};for(let s=0;s<n.length&&!D;s++){let o=n[s],i=o.name;console.log("current_questionnaire:",i),a.name=i,a.transactions={};let r=o.max_score,l=o.introduction;await O(l,e,!1);let c=o.questions,u=o.target_questions,g=o.response_categories,m=o.response_categories_match,p=o.scoring_categories;console.log("questions:",c),console.log("scoring_categories:",p);let f=0;a.total_questionnaire_score=f;for(let n=0;n<c.length&&!D;n++){let o=0,i=c[n],r=u[n],l=g[n],w=m[n],k=p[n];a.transactions["Q".concat(n)]={},a.transactions["Q".concat(n)].start_question=i,a.transactions["Q".concat(n)].target_question=r,a.transactions["Q".concat(n)].text_emotions={},a.transactions["Q".concat(n)].facial_emotions={},a.transactions["Q".concat(n)].responses={};let b=i,N=Y(l).toLowerCase().trim();if(i="".concat(b," ").concat(N),await O(b,e,!1),await O(N,e,!1),a.transactions["Q".concat(n)].responses["".concat(o,": agent")]=i,a.transactions["Q".concat(n)].responses["".concat(o,": user")]="",a.transactions["Q".concat(n)].text_emotions["".concat(o,": agent")]="",a.transactions["Q".concat(n)].text_emotions["".concat(o,": user")]="",a.transactions["Q".concat(n)].facial_emotions["".concat(o,": agent")]="",a.transactions["Q".concat(n)].facial_emotions["".concat(o,": user")]="",a.transactions["Q".concat(n)].user_valid_responses=l,a.transactions["Q".concat(n)].user_valid_match_responses=w,D)break;let E=!1,x=!1,T=null,L=0,I=2;for(;(!E||null==T)&&!D;){let c="";for(;!c&&!D;){v=!0,c=await z(e,!1);let t=c.timestamp;if(console.log("user_response_timestamp:",t),v=!1,console.log("before - capturedEmotionsList:",_),_.length>0&&(y=ne(t),console.log("latestFacialEmotionTupleOnSpeak:",y)),_=[],console.log("after - capturedEmotionsList:",_),c=c.text,console.log("user_response:",c),D)break;if(!c){if(console.log("USER RESPONSE NOT PROVIDED!"),console.log("repeat_count - 1:",L),L>=I)return L=0,await O("It seems you've used all your attempts to answer the current questions. Unfortunately, all questions must be answered as part of the intervention procedure to provide a valid evaluation. When you're ready to answer all the questions in the intervention, feel free to restart this module. Thank you for your time and participation.",e,!1),void ce();{L+=1;let t="It seems I wasn't able to hear what you said. Let me repeat the question.";await O(t,e,!1),await O(b,e,!1),await O(N,e,!1)}}if(D)break}if(!c)break;if(C="Processing response. Please wait...",he(),await M(500),t&&e({title:"eEVA Response",description:"Processing response. Please wait...",status:"warning",duration:0,isClosable:!1}),D)break;let u=V(c);if(console.log("cleaned_user_response:",u),a.transactions["Q".concat(n)].text_emotions["".concat(o,": agent")]="",a.transactions["Q".concat(n)].text_emotions["".concat(o,": user")]="",a.transactions["Q".concat(n)].facial_emotions["".concat(o,": agent")]="",a.transactions["Q".concat(n)].facial_emotions["".concat(o,": user")]="",a.transactions["Q".concat(n)].responses["".concat(o,": agent")]=i,a.transactions["Q".concat(n)].responses["".concat(o,": user")]=u,D)break;if(E=await W(u,i),console.log("is_response_relevant:",E),D)break;if(x=await W(u,r),console.log("is_response_relevant_target:",x),D)break;let g=n%2==0;if(E&&x){T=await J(u,w),console.log("likert_matched_response_index:",T);let r=w[T];if(D)break;let l=await te(i),c=await te(u),m=d[l],p=d[c];if(console.log("agent_matched_text_emotion_".concat(n,":"),m),console.log("user_matched_text_emotion:_".concat(n,":"),p),a.transactions["Q".concat(n)].text_emotions["".concat(o,": agent")]=m,a.transactions["Q".concat(n)].text_emotions["".concat(o,": user")]=p,a.transactions["Q".concat(n)].responses["".concat(o,": agent")]=i,a.transactions["Q".concat(n)].responses["".concat(o,": user")]=u,y&&(a.transactions["Q".concat(n)].facial_emotions["".concat(o,": user")]=y[0]),o+=1,D)break;if(null!=T){if(D)break;if(g){let s=await K(u,i,r);await O(s,e,!1);let l="",c=!1;if(D)break;for(;!l&&!D&&(l=await z(e,!1),t&&e({title:"eEVA Response",description:"Processing response. Please wait...",status:"warning",duration:0,isClosable:!1}),l=V(l.text),!D);){let t=await te(i),r=await te(u),c=d[t],h=d[r];if(console.log("agent_matched_text_emotion_".concat(n,":"),c),console.log("user_matched_text_emotion:_".concat(n,":"),h),a.transactions["Q".concat(n)].text_emotions["".concat(o,": agent")]=c,a.transactions["Q".concat(n)].text_emotions["".concat(o,": user")]=h,a.transactions["Q".concat(n)].responses["".concat(o,": agent")]=s,a.transactions["Q".concat(n)].responses["".concat(o,": user")]=l,o+=1,D)break;if(!l){if(console.log("CONFIRMATION RESPONSE NOT PROVIDED!"),console.log("repeat_count - 2:",L),L>=I)return L=0,await O("It seems you've used all your attempts to answer the current questions. Unfortunately, all questions must be answered as part of the intervention procedure to provide a valid evaluation. When you're ready to answer all the questions in the intervention, feel free to restart this module. Thank you for your time and participation.",e,!1),void ce();{L+=1;let t="It seems I wasn't able to hear what you said. Let me repeat the question.";await O(t,e,!1),await O(b,e,!1),await O(N,e,!1)}}}if(!l)break;console.log("confirmation_response:",l),c=await X(l,s),console.log("is_response_confirmed:",c);let h=Math.floor(Math.random()*q.length),g=q[h];if(!c){await O("".concat(g,". Let me repeat the question."),e,!1),await O(i,e,!1),a.transactions["Q".concat(n)].responses["".concat(o,": agent")]=s,E=!1,T=null;continue}re(),await M(3e3)}}if(D)break;if(null!=T){let e=k[T];console.log("response_score:",e),a.transactions["Q".concat(n)].match_index=T,a.transactions["Q".concat(n)].response_match=r,a.transactions["Q".concat(n)].response_score=e,void 0==h.transcript.questionnaires[s]?h.transcript.questionnaires.push(a):h.transcript.questionnaires[s]=a,f+=e,a.total_questionnaire_score=f,console.log("conversation_log: ".concat(JSON.stringify(h,null,2)))}}if(o+=1,null==T){console.log("RESPONSE IS CANNOT BE MATCHED!"),console.log("CONTINUE WITH FOLLOWUP!");let g=await $(u,i,r),m=!0;if(D)break;for(;(!E||null==T)&&(m?(await O(g,e,!1),m=!1,i=g):(await O(r,e,!1),i=r),!D);){for(a.transactions["Q".concat(n)].responses["".concat(o,": agent")]=i,c="";!c&&!D;){v=!0,c=await z(e,!1);let t=c.timestamp;if(console.log("user_response_timestamp:",t),v=!1,console.log("before - capturedEmotionsList:",_),_.length>0&&(y=ne(t),console.log("latestFacialEmotionTupleOnSpeak:",y)),_=[],console.log("after - capturedEmotionsList:",_),c=c.text,console.log("user_response:",c),D)break;if(!c){if(console.log("USER RESPONSE NOT PROVIDED!"),console.log("repeat_count - 2:",L),L>=I)return L=0,await O("It seems you've used all your attempts to answer the current questions. Unfortunately, all questions must be answered as part of the intervention procedure to provide a valid evaluation. When you're ready to answer all the questions in the intervention, feel free to restart this module. Thank you for your time and participation.",e,!1),void ce();{L+=1;let t="It seems I wasn't able to hear what you said. Let me repeat the question.";await O(t,e,!1),await O(b,e,!1),await O(N,e,!1)}}if(D)break}if(!c)break;if(await M(500),t&&e({title:"eEVA Response",description:"Processing response. Please wait...",status:"warning",duration:0,isClosable:!1}),D)break;if(u=V(c),console.log("cleaned_user_response:",u),a.transactions["Q".concat(n)].text_emotions["".concat(o,": agent")]="",a.transactions["Q".concat(n)].text_emotions["".concat(o,": user")]="",a.transactions["Q".concat(n)].facial_emotions["".concat(o,": agent")]="",a.transactions["Q".concat(n)].facial_emotions["".concat(o,": user")]="",a.transactions["Q".concat(n)].responses["".concat(o,": user")]=u,D)break;if(E=await W(u,i),console.log("is_response_relevant:",E),x=await W(u,r),console.log("is_response_relevant_target:",x),D)break;if(E||x){let e=await te(i),t=await te(u),r=d[e],c=d[t];if(console.log("agent_matched_text_emotion_".concat(n,":"),r),console.log("user_matched_text_emotion:_".concat(n,":"),c),a.transactions["Q".concat(n)].text_emotions["".concat(o,": agent")]=r,a.transactions["Q".concat(n)].text_emotions["".concat(o,": user")]=c,y&&(a.transactions["Q".concat(n)].facial_emotions["".concat(o,": user")]=y[0]),T=await J(u,l),console.log("likert_match_response_index:",T),D)break;if(null!=T){let e=k[T];console.log("response_score:",e),a.transactions["Q".concat(n)].match_index=T,a.transactions["Q".concat(n)].response_match=l[T],a.transactions["Q".concat(n)].response_score=e,void 0==h.transcript.questionnaires[s]?h.transcript.questionnaires.push(a):h.transcript.questionnaires[s]=a,f+=e,a.total_questionnaire_score=f,console.log("conversation_log: ".concat(JSON.stringify(h,null,2)))}}if(null==T){if(console.log("RESPONSE IS NOT RELEVANT!"),console.log("is_response_relevant:",E),console.log("repeat_count - 3:",L),L>=I)return L=0,await O("It seems you've used all your attempts to answer the current questions. Unfortunately, all questions must be answered as part of the intervention procedure to provide a valid evaluation. When you're ready to answer all the questions in the intervention, feel free to restart this module. Thank you for your time and participation.",e,!1),void ce();{L+=1;let t="May you please rephrase and elaborate your response? Let me repeat the question.";await O(t,e,!1),await O(b,e,!1),await O(N,e,!1)}}}break}}}if(!D&&(await O("It appears you've answered all the questions from the ".concat(i,". Let me evaluate your score."),e,!1),await O("You've score a ".concat(f," out of ").concat(r,"."),e,!1),"AUDIT questionnaire"==i))switch(console.log("Evaluating AUDIT questionnaire score..."),console.log("questionnaire_score:",f),!0){case f>=0&&f<=7:await O("This means you fall under risk level 1 and are to be provided some alcohol education.",e,!1);break;case f>=8&&f<=15:await O("This means you fall under risk level 2 and are to be provided some simple advice.",e,!1);break;case f>=16&&f<=19:await O("This means you fall under risk level 3 and are to be provided some simple advice plus brief counseling and continued monitoring.",e,!1);break;case f>=20:await O("This means you fall under risk level 4 and are to be referred to a specialist for diagnostic evaluation and treatment.",e,!1)}}await O("Ending intervention procedure.",e,!1),C="",he()}(e,!1)):(console.log("RUNNING AGENT DRIVEN INTERVENTION!!!"),e({title:"eEVA Procedure",description:"RUNNING AGENT DRIVEN INTERVENTION!!!",status:"success",duration:0,isClosable:!1}),async function(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];U(),oe(),ue();let o=I.agent_greeting;await O(I.agent_greeting,e,!1),await O(I.introduction,e,!1),h.transcript.introduction="".concat(o," ").concat(I.introduction);let n=I.questionnaires,a={};for(let s=0;s<n.length&&!D;s++){let o=n[s],i=o.name;console.log("current_questionnaire:",i),a.name=i,a.transactions={};let r=o.max_score,l=o.introduction;await O(l,e,!1);let c=o.questions,u=o.response_categories,g=o.response_categories_match,m=o.scoring_categories;console.log("questions:",c),console.log("valid_user_responses",u),console.log("valid_match_user_responses:",g),console.log("scoring_categories:",m);let p=0;a.total_questionnaire_score=p;for(let n=0;n<c.length&&!D;n++){let o=0,i=c[n],r=u[n],l=g[n],f=m[n];a.transactions["Q".concat(n)]={},a.transactions["Q".concat(n)].question=i,a.transactions["Q".concat(n)].text_emotions={},a.transactions["Q".concat(n)].facial_emotions={},a.transactions["Q".concat(n)].responses={};let w=i,k=Y(r).toLowerCase().trim();i="".concat(w," ").concat(k),await O(w,e,!1),await O(k,e,!1),a.transactions["Q".concat(n)].responses["".concat(o,": agent")]=i,a.transactions["Q".concat(n)].responses["".concat(o,": user")]="",a.transactions["Q".concat(n)].text_emotions["".concat(o,": agent")]="",a.transactions["Q".concat(n)].text_emotions["".concat(o,": user")]="",a.transactions["Q".concat(n)].facial_emotions["".concat(o,": agent")]="",a.transactions["Q".concat(n)].facial_emotions["".concat(o,": user")]="",a.transactions["Q".concat(n)].user_valid_responses=r,a.transactions["Q".concat(n)].user_valid_match_responses=l;let b=!1,N=null,E=0,x=2;for(;(!b||null==N)&&!D;){let r="";for(;!r&&!D;){v=!0,r=await z(e,!1);let t=r.timestamp;if(console.log("user_response_timestamp:",t),v=!1,console.log("before - capturedEmotionsList:",_),_.length>0&&(y=ne(t),console.log("latestFacialEmotionTupleOnSpeak:",y)),_=[],console.log("after - capturedEmotionsList:",_),r=r.text,console.log("user_response:",r),D)break;if(!r){if(console.log("USER RESPONSE NOT PROVIDED!"),console.log("user_response:",r),E>=x){E=0;let t="It seems you've used all your attempts to answer the current questions. Unfortunately, all questions must be answered as part of the intervention procedure to provide a valid evaluation. When you're ready to answer all the questions in the intervention, feel free to restart this module. Thank you for your time and participation.";return await O(t,e,!1),void ce()}{E+=1;let t="It seems I wasn't able to hear what you said. Let me repeat the question.";await O(t,e,!1),await O(w,e,!1),await O(k,e,!1)}}if(D)break}if(!r)break;if(await M(500),C="Processing response. Please wait...",he(),t&&e({title:"eEVA Response",description:"Processing response. Please wait...",status:"warning",duration:5e3,isClosable:!1}),D)break;let c=V(r);if(console.log("cleaned_user_response:",c),a.transactions["Q".concat(n)].text_emotions["".concat(o,": agent")]="",a.transactions["Q".concat(n)].text_emotions["".concat(o,": user")]="",a.transactions["Q".concat(n)].facial_emotions["".concat(o,": agent")]="",a.transactions["Q".concat(n)].facial_emotions["".concat(o,": user")]="",a.transactions["Q".concat(n)].responses["".concat(o,": agent")]=i,a.transactions["Q".concat(n)].responses["".concat(o,": user")]=c,b=await W(c,i),console.log("is_response_relevant:",b),D)break;let u=n%2==0;if(b){console.log("current_valid_match_user_responses",l),N=await J(c,l),console.log("likert_matched_response_index:",N);let t=l[N];if(D)break;let r=await te(i),g=await te(c),m=d[r],v=d[g];if(console.log("agent_matched_text_emotion_".concat(n,":"),m),console.log("user_matched_text_emotion:_".concat(n,":"),v),a.transactions["Q".concat(n)].text_emotions["".concat(o,": agent")]=m,a.transactions["Q".concat(n)].text_emotions["".concat(o,": user")]=v,y&&(a.transactions["Q".concat(n)].facial_emotions["".concat(o,": user")]=y[0]),o+=1,D)break;if(null!=N){if(D)break;let o=Math.floor(Math.random()*q.length),i=q[o];u&&await O("".concat(i,". Let's move on to the next question."),e,!1);let r=f[N];console.log("response_score:",r),a.transactions["Q".concat(n)].match_index=N,a.transactions["Q".concat(n)].response_match=t,a.transactions["Q".concat(n)].response_score=r,void 0==h.transcript.questionnaires[s]?h.transcript.questionnaires.push(a):h.transcript.questionnaires[s]=a,p+=r,a.total_questionnaire_score=p,console.log("conversation_log: ".concat(JSON.stringify(h,null,2)))}else{if(console.log("LIKERT_MATCHED_RESPONSE_INDEX NOT PRODUCED!"),console.log("likert_matched_response_index:",N),E>=x){E=0;let t="It seems you've used all your attempts to answer the current questions. Unfortunately, all questions must be answered as part of the intervention procedure to provide a valid evaluation. When you're ready to answer all the questions in the intervention, feel free to restart this module. Thank you for your time and participation.";return await O(t,e,!1),void ce()}{E+=1;let t="May you please rephrase and elaborate your response? Let me repeat the question.";await O(t,e,!1),await O(w,e,!1),await O(k,e,!1)}}}else{if(console.log("RESPONSE IS NOT RELEVANT!"),console.log("is_response_relevant:",b),E>=x){E=0;let t="It seems you've used all your attempts to answer the current questions. Unfortunately, all questions must be answered as part of the intervention procedure to provide a valid evaluation. When you're ready to answer all the questions in the intervention, feel free to restart this module. Thank you for your time and participation.";return await O(t,e,!1),void ce()}{E+=1;let t="May you please rephrase and elaborate your response? Let me repeat the question.";await O(t,e,!1),await O(w,e,!1),await O(k,e,!1)}}if(D)break}}if(!D&&(await O("It appears you've answered all the questions from the ".concat(i,". Let me evaluate your score."),e,!1),await O("You've score a ".concat(p," out of ").concat(r,"."),e,!1),"AUDIT questionnaire"==i))switch(console.log("Evaluating AUDIT questionnaire score..."),console.log("questionnaire_score:",p),!0){case p>=0&&p<=7:await O("This means you fall under risk level 1 and are to be provided some alcohol education.",e,!1);break;case p>=8&&p<=15:await O("This means you fall under risk level 2 and are to be provided some simple advice.",e,!1);break;case p>=16&&p<=19:await O("This means you fall under risk level 3 and are to be provided some simple advice plus brief counseling and continued monitoring.",e,!1);break;case p>=20:await O("This means you fall under risk level 4 and are to be referred to a specialist for diagnostic evaluation and treatment.",e,!1)}}D||await O("It seems we've covered all the questionnaires.",e,!1),await O("Ending intervention procedure.",e,!1),C="",he()}(e,!1))}function se(){let e=[{id:"51",intensity:.12222222222222222,duration:750,explanation:""},{id:"53",intensity:.06666666666666667,duration:750,explanation:""},{id:"55",intensity:.16666666666666666,duration:750,explanation:""}];!function(e){e.forEach((e=>{let{id:t,intensity:o,duration:n,explanation:a=""}=e;animationManager.scheduleChange(t,90*o,n,0,a)}))}(e)}function ie(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.5;console.log("skipList:",e),n.I.forEach((o=>{console.log("current AU.id:",o.id),e.includes(o.id)?console.log("skipping AU.id:",o.id):animationManager.applyAUChange(o.id,0,0,"",t,"")})),n.FV.forEach((e=>{animationManager.scheduleVisemeChange(e.id,0,750)})),se()}async function re(){ie(["45","51","53","55"]),await M(1e3),animationManager.applyAUChange("54",15,0,"",2,""),await M(1e3),ie(["45","51","53","55"],3)}async function le(e,t,o){if(console.clear(),console.log("Calling start!"),ie(["45","51","53","55"]),p&&clearInterval(p),!o||!o.current)return void console.error("Invalid container reference");f||(f=a.createRoot(o.current)),Q=!1,console.log("settings:",t),S=t.active_listening_trigger,function(e,t){console.log("azure key object:",t.azure_api_key),console.log("azure key object type:",typeof t.azure_api_key),console.log("azure key default:",t.azure_api_key.default),L=t.azure_api_key&&"string"==typeof t.azure_api_key?new l.A(e,t.azure_api_key,"eastus"):new l.A(e,t.azure_api_key.default,"eastus")}(e,t);const n=()=>{const o=(0,c.d)();!function(e,t,o){w=s.createRef(),o.render((0,u.jsx)(i.A,{animationManager:e,settings:t,onEmotionDetected:A,stopVideoRef:w}))}(e,t,f),function(e){p&&clearInterval(p),p=setInterval((()=>{e.scheduleChange("45",200,100,0),setTimeout((()=>e.scheduleChange("45",0,100,0)),600)}),k+400)}(e),ae(o)};f.render((0,u.jsx)(n,{}))}function ce(e,t,o){console.log("Calling stop!"),w&&w.current&&w.current(),f&&(f.unmount(),f=null),C="",he(),p&&clearInterval(p),R&&(Q=!0,T.stop(),console.log("speech recognition stopped!")),D=!0}function ue(){if(!document.getElementById("bottomBox")){const e=document.createElement("div");e.id="bottomBox",e.style.position="fixed",e.style.bottom="20px",e.style.left="50%",e.style.transform="translateX(-50%)",e.style.width="80%",e.style.backgroundColor="#333",e.style.color="#fff",e.style.padding="8px",e.style.textAlign="center",e.style.zIndex="1000",e.style.fontSize="18px",e.style.borderRadius="8px",document.body.appendChild(e)}}function he(){const e=document.getElementById("bottomBox");e&&(""===C.trim()?(e.innerText="",e.style.opacity="0.5"):(e.innerText=C,e.style.opacity="1"))}},41591:()=>{},82766:()=>{},61065:()=>{},3886:()=>{},26308:()=>{},42250:()=>{},29645:()=>{},88632:()=>{},13678:()=>{},44573:()=>{},10952:()=>{},74463:()=>{}}]);
//# sourceMappingURL=743.454e9461.chunk.js.map